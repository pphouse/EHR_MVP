# Azure OpenAI API 電子カルテシステム要件定義書

## 1. ドキュメント目的

本書は、生成 AI の安全性確保を目的としたセーフティレイヤー（Azure OpenAI API）を統合した次世代電子カルテ（以下、本システム）の要件を明確化し、開発・運用フェーズに共通認識を提供するために作成する。

## 2. 背景 / 課題

- 生成 AI のハルシネーションや機微情報漏えいが医療事故・訴訟リスクを高めている。
- 医師の文書負担、診療情報の断片化、インシデント管理の属人化が課題。
- 厚労省ガイドライン・GDPR・個人情報保護法・医療 ISMS (ISO 27799) への準拠が必須。

## 3. 目標 / 成功指標 (KGI・KPI)

| 区分       | 指標                        | 目標値      |
| ---------- | --------------------------- | ----------- |
| 医療安全   | 危険出力抑制率              | ≥ 90 %      |
| 情報漏えい | PII 検知 F1                 | ≥ 0.85      |
| 文書効率   | 診療記載時間短縮            | 30 %以上    |
| 性能       | 平均応答時間 (チャート操作) | ≤ 1.0 s     |
| 可用性     | システム稼働率              | 99.9 % / 年 |

## 4. 対象範囲

- 個人クリニック～中規模病院（外来・入院）
- 日本国内の保険診療・自由診療
- 初期バージョンは内科系ワークフローを中心に実装

## 5. システム概要

### 5.1 全体アーキテクチャ

```
| フロントエンド (React + TypeScript) |
| └── FHIR Gateway (GraphQL Wrapper) |
|      ├── Core EMR Service (SOAP, 処方, 検査) |
|      ├── AI Assistant Service |
|      │     ├── Generator LLM (国産 6–13B) |
|      │     └── Auditor LLM (Azure OpenAI API) |
|      ├── Identity & Access (OAuth2 / OpenID) |
|      └── Audit Log & Risk DB |
| バックエンド (Go / Python microservices, k8s) |
```

### 5.2 モジュール構成

1. **患者管理**
2. **診療記録 (SOAP)**
3. **オーダリング (処方・検査・画像)**
4. **退院サマリー自動生成**
5. **AI 診断補助**
6. **Azure OpenAI API セーフティレイヤー**
7. **FHIR API / 外部連携**
8. **運用・監査**

## 6. 機能要件

### 6.1 電子カルテ基本機能

- 患者基本情報 CRUD, 既往歴・アレルギー登録
- SOAP 入力支援 (テンプレート & タイムスタンプ)
- 医薬品辞書連携 (YJ, HOT 基準)
- 検査結果自動取り込み (LIS / PACS; HL7 v2)

### 6.2 Azure OpenAI API セーフティレイヤー

| 番号 | 機能                 | 詳細                                                       |
| ---- | -------------------- | ---------------------------------------------------------- |
| S‑1  | ハルシネーション検知 | PubMed / ガイドラインで Claim 単位評価し、信頼度スコア付与 |
| S‑2  | PII 漏えい検知       | 正規化辞書 + 埋め込み類似度で検出・マスキング              |
| S‑3  | 自動リライト         | 閾値超過時に安全な代替文生成、操作ログ保存                 |
| S‑4  | 可視化 UI            | ハイライト+リスクヒートマップを診療画面にオーバーレイ      |
| S‑5  | 監査ログ             | JSON‑L 形式で保存、改ざん検知ハッシュ付与                  |

### 6.3 AI 診断補助

- 症状・検査結果から鑑別診断候補を提示
- 推薦理由を重要度ソートで表示 (SHAP + Attention Map)

### 6.4 退院サマリー自動生成

- 主訴 / 入院経過 / 投薬 / 検査ハイライトを自動抽出
- Azure OpenAI API を介してリスク検査後に出力

### 6.5 認証・権限管理

- OAuth2 (Auth Code + PKCE) / OpenID Connect
- RBAC: 医師・看護師・事務・監査・研究者
- SSO (SAML 2.0) オプション

### 6.6 オペレーション

- Smart‑on‑FHIR アプリ登録
- アラート & 通知 (LINE / email / PagerDuty)

## 7. 非機能要件

| 項目         | 要件                                                      |
| ------------ | --------------------------------------------------------- |
| 性能         | 主要画面 < 1 s, 99th パーセンタイル < 2 s                 |
| 可用性       | マルチ AZ, 自動フェイルオーバ (k8s + Istio)               |
| セキュリティ | AES‑256 at‑rest, TLS 1.3 in‑transit, WAF, IDS             |
| プライバシー | 匿名加工・統計的秘匿 (k‑anonymity ≥ 5)                    |
| 拡張性       | マイクロサービス, Helm チャート, GitOps                   |
| 規格準拠     | HL7 FHIR R5 JP Core, ISO 15189, ISO 27799                 |
| 運用         | IaC (Terraform), CI/CD (GitHub Actions), SRE error budget |

## 8. データ要件

- **データモデル**: FHIR リソース (Patient, Encounter, Observation, MedicationRequest 等)
- **コード体系**: ICD‑10, SNOMED CT, LOINC, YJ, HOT, JAMI 検体検査マスター
- **辞書更新**: 月次自動インポート

## 9. インターフェース要件

| 名称          | プロトコル | 方向   | 内容               |
| ------------- | ---------- | ------ | ------------------ |
| FHIR REST API | HTTPS/JSON | 内外   | CRUD & Bulk export |
| HL7 v2 Lab    | MLLP       | 外部 ← | 検査結果取込       |
| Claim 電算    | XML        | 外部 → | レセプト提出       |
| OAuth2        | HTTPS      | 双方向 | 認証・権限連携     |

## 10. UI/UX 要件

- モバイルファースト (タブレット対応)
- アクセシビリティ: JIS X 8341‑3 準拠 (WCAG 2.1 AA)
- 危険出力時はリスクバッジ + ポップアップ説明

## 11. 安全性・リスク管理要件

1. リスクシナリオ毎に ISO 14971 に準拠した FMEA 実施
2. セーフティレイヤーの誤検知率・漏検知率を四半期レビュー
3. 監査ログを 7 年間保存し、KMS で鍵管理

## 12. 運用要件

- 24/365 監視 (Prometheus + Grafana + Alertmanager)
- リリース: Canary → Blue‑Green 本番切替
- DR: RPO 4 h / RTO 2 h

## 13. テスト / 評価計画

| テスト区分 | 重点項目                      | 基準                    |
| ---------- | ----------------------------- | ----------------------- |
| 単体       | 各 API, Schema Validation     | 100 % 自動化            |
| 結合       | ワークフロー, RBAC, LLM  連携 | 主要シナリオ 100 % 通過 |
| 性能       | 同時接続 500, TPS 50          | スローダウン < 10 %     |
| 安全性     | Hallucination, PII Leak       | KPI 達成                |
| UAT        | 医師 5 名, 看護師 3 名        | NPS ≥ +30               |

## 14. 移行 / 展開計画

1. 既存カルテ (CSV, HL7 CDA) を FHIR へ ETL
2. パラレルラン実施 (4 週間) → 本番切替
3. ユーザ教育: e‑Learning + ワークショップ

## 15. スケジュール (概算)

| 月  | マイルストーン                       |
| --- | ------------------------------------ |
| 0   | 要件凍結 / Kick‑off                  |
| 1   | 基盤構築 / FHIR GW PoC               |
| 3   | Azure OpenAI API v0 統合             |
| 4   | ベータ版導入 + UAT                   |
| 6   | 本番リリース                         |
| 9   | 医科‐歯科連携拡張, 金融保証 API 連携 |

## 16. 体制

- プロダクトオーナー (医師) × 1
- LLM リード (AI 研究者) × 1
- バックエンド / SRE × 2
- フロントエンド × 1
- UX / QA × 1

## 17. コスト見積 (税別, 百万円)

| 区分                | 初期   | 年間運用 |
| ------------------- | ------ | -------- |
| 人件費              | 60     | 25       |
| インフラ (GPU, k8s) | 15     | 8        |
| ライセンス / API    | 6      | 3        |
| 監査・保険          | 4      | 2        |
| **合計**            | **85** | **38**   |

## 18. 用語集

- **Azure OpenAI API**: 本システム専用の監査用 LLM
- **FHIR**: Fast Healthcare Interoperability Resources
- **PII**: Personally Identifiable Information
- **SOAP**: Subjective, Objective, Assessment, Plan

---

### 添付

- アーキテクチャ詳細図 (別紙)
- データフロー図 (DFD) レベル 0 / 1
- FMEA テンプレート
